<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ß–∞—Ç—Ä—É–ª–µ—Ç–∫–∞</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
    #usersOnline { margin: 20px 0; padding: 10px 20px; background: #f3f3f3; border-radius: 10px; min-width: 250px; }
    .user-row { display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; }
    .user-row.me { background: #e0ffe0; cursor: default; }
    .user-avatar { width: 40px; height: 30px; border-radius: 5px; margin-right: 8px; object-fit: cover; background: #eee; }
    .user-label { font-size: 1.1em; }
    #addAvatarBtn { margin-bottom: 15px; }
    #status { margin: 10px 0; color: #1c6; }
    #videos { display: flex; gap: 20px; margin: 15px 0; }
    video { width: 240px; height: 180px; background: #000; border-radius: 8px; }
    #logWindow {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      height: 220px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 10px;
      overflow-y: auto;
      border-radius: 7px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
      box-shadow: 0 2px 8px #0008;
    }
    #logContent div { margin: 2px 0; word-break: break-word; }
  </style>
</head>
<body>
  <h2>–í—ã–±–µ—Ä–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>
  <select id="instrument">
    <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>
    <option value="guitar">–ì–∏—Ç–∞—Ä–∞</option>
    <option value="keyboard">–ö–ª–∞–≤–∏—à–∏</option>
    <option value="drums">–ë–∞—Ä–∞–±–∞–Ω—ã</option>
  </select>

  <button id="addAvatarBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–±—è —Å –∫–∞–º–µ—Ä–æ–π</button>

  <div id="status"></div>
  <div id="usersOnline"><b>–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:</b> ‚Äî</div>

  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div id="logWindow"><div id="logContent"></div></div>

  <script>
    // --- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ---
    const logContent = document.getElementById('logContent');
    const logWindow = document.getElementById('logWindow');
    function logMessage(message, type = 'info') {
      const colors = {
        info: '#00ff00',
        error: '#ff5555',
        warning: '#ffff00',
        signal: '#00ffff'
      };
      const logEntry = document.createElement('div');
      logEntry.style.color = colors[type] || '#fff';
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContent.appendChild(logEntry);
      logWindow.scrollTop = logWindow.scrollHeight;
    }

    // --- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${wsProtocol}://${location.host}/`);

    const instrumentSelect = document.getElementById('instrument');
    const usersOnlineDiv = document.getElementById('usersOnline');
    const addAvatarBtn = document.getElementById('addAvatarBtn');
    const statusDiv = document.getElementById('status');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    let myId = null;
    let peerId = null;
    let peerConnection = null;
    let localStream = null;
    let pendingCandidates = [];

    // --- TURN/STUN –∫–æ–Ω—Ñ–∏–≥ ---
    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      {
        urls: 'turn:82.147.84.236:3478',
        username: 'webrtc',
        credential: 'supersecret'
      }
    ];

    ws.onopen = () => {
      logMessage('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
      ws.send(JSON.stringify({ type: 'register', instrument: instrumentSelect.value }));
    };

    ws.onerror = (error) => {
      logMessage(`WebSocket –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
    };

    instrumentSelect.onchange = () => {
      ws.send(JSON.stringify({ type: 'register', instrument: instrumentSelect.value }));
      logMessage('–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–±—Ä–∞–Ω: ' + instrumentSelect.value, 'info');
    };

    addAvatarBtn.onclick = async () => {
      try {
        logMessage('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...', 'info');
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        logMessage('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'info');

        // –î–µ–ª–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å –∫–∞–º–µ—Ä—ã –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
        const video = document.createElement('video');
        video.srcObject = localStream;
        await video.play();

        const canvas = document.createElement('canvas');
        canvas.width = 80;
        canvas.height = 60;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const image = canvas.toDataURL('image/jpeg');

        ws.send(JSON.stringify({ type: 'avatar', image }));
        logMessage('–ê–≤–∞—Ç–∞—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä', 'info');
      } catch (e) {
        logMessage('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + e.message, 'error');
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
      }
    };

    usersOnlineDiv.onclick = (event) => {
      let row = event.target.closest('.user-row[data-userid]');
      if (row && row.dataset.userid && row.dataset.userid !== myId) {
        ws.send(JSON.stringify({ type: 'connect', targetId: row.dataset.userid }));
        logMessage('–ó–∞–ø—Ä–æ—à–µ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ' + row.dataset.userid, 'info');
      }
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'clients') {
        if (!myId && data.users.length > 0) {
          myId = data.users[data.users.length - 1].id;
          logMessage('–ú–æ–π id: ' + myId, 'info');
        }
        usersOnlineDiv.innerHTML = '<b>–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:</b><br>' +
          data.users.map(u => {
            let label = '';
            if (!u.instrument) label = 'üë§ –ì–æ—Å—Ç—å';
            if (u.instrument === 'guitar') label = 'üé∏ –ì–∏—Ç–∞—Ä–∞';
            if (u.instrument === 'keyboard') label = 'üéπ –ö–ª–∞–≤–∏—à–∏';
            if (u.instrument === 'drums') label = 'ü•Å –ë–∞—Ä–∞–±–∞–Ω—ã';
            let meClass = (u.id === myId) ? 'me' : '';
            let dataId = (u.id && u.id !== myId) ? `data-userid="${u.id}"` : '';
            if (u.avatar) {
              return `<div class="user-row ${meClass}" ${dataId}><img class="user-avatar" src="${u.avatar}"><span class="user-label">${label}</span></div>`;
            } else {
              return `<div class="user-row ${meClass}" ${dataId}><span class="user-label">${label}</span></div>`;
            }
          }).join('');
      }
      if (data.type === 'status') {
        statusDiv.textContent = data.message;
        logMessage('–°—Ç–∞—Ç—É—Å: ' + data.message, 'info');
        if (data.peerId) {
          peerId = data.peerId;
          if (peerId) {
            logMessage('–ù–∞—á–∏–Ω–∞–µ–º WebRTC —Å peerId: ' + peerId, 'info');
            startWebRTC(peerId);
          } else {
            closeWebRTC();
            logMessage('WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'info');
          }
        }
      }
      if (data.type === 'signal') {
        logMessage('–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª: ' + (data.signal.type || 'candidate'), 'signal');
        if (!peerConnection) {
          peerConnection = createPeerConnection();
        }
        if (data.signal.type === 'offer') {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
          logMessage('setRemoteDescription(offer)', 'info');
          if (!localStream) {
            try {
              localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
              localVideo.srcObject = localStream;
              localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
              logMessage('–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–∞', 'info');
            } catch (e) {
              logMessage('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è WebRTC: ' + e.message, 'error');
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è WebRTC');
              return;
            }
          }
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'signal', signal: answer }));
          logMessage('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω answer', 'signal');
        } else if (data.signal.type === 'answer') {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
          logMessage('setRemoteDescription(answer)', 'info');
        } else if (data.signal.candidate) {
          if (peerConnection.remoteDescription) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.signal));
            logMessage('addIceCandidate (—Å—Ä–∞–∑—É)', 'signal');
          } else {
            pendingCandidates.push(data.signal);
            logMessage('ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–æ remoteDescription', 'warning');
          }
        }
      }
    };

    function createPeerConnection() {
      const pc = new RTCPeerConnection({ iceServers });

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: 'signal', signal: event.candidate }));
          logMessage('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç', 'signal');
        }
      };

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
        logMessage('–ü–æ–ª—É—á–µ–Ω –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞', 'info');
      };

      if (localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        logMessage('–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ PeerConnection', 'info');
      }

      pc.onconnectionstatechange = () => {
        logMessage('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + pc.connectionState, 'info');
      };

      return pc;
    }

    async function startWebRTC(targetPeerId) {
      if (!peerConnection) peerConnection = createPeerConnection();
      if (!localStream) {
        try {
          logMessage('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è WebRTC...', 'info');
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
          logMessage('–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏', 'info');
        } catch (e) {
          logMessage('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è WebRTC: ' + e.message, 'error');
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è WebRTC');
          return;
        }
      }
      // –¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç offer
      if (targetPeerId && myId) {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: 'signal', signal: offer }));
        logMessage('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω offer', 'signal');
      }
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç—ã
      if (pendingCandidates.length && peerConnection.remoteDescription) {
        for (const candidate of pendingCandidates) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          logMessage('addIceCandidate (–æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π)', 'signal');
        }
        pendingCandidates = [];
      }
    }

    function closeWebRTC() {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      remoteVideo.srcObject = null;
    }
  </script>
</body>
</html>
