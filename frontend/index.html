<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ß–∞—Ç—Ä—É–ª–µ—Ç–∫–∞</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
    video { width: 300px; height: 225px; background: #000; margin: 10px; }
    #videos { display: flex; gap: 20px; }
    #usersOnline { margin: 20px 0; padding: 10px 20px; background: #f3f3f3; border-radius: 10px; min-width: 250px; }
  </style>
</head>
<body>
  <h2>–í—ã–±–µ—Ä–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>
  <select id="instrument">
    <option value="guitar">–ì–∏—Ç–∞—Ä–∞</option>
    <option value="keyboard">–ö–ª–∞–≤–∏—à–∏</option>
    <option value="drums">–ë–∞—Ä–∞–±–∞–Ω—ã</option>
  </select>
  <button id="start">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>

  <div id="usersOnline"><b>–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:</b> ‚Äî</div>

  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <script>
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è WebSocket
    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${wsProtocol}://${location.host}/`);

    const startBtn = document.getElementById('start');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const instrumentSelect = document.getElementById('instrument');
    const usersOnlineDiv = document.getElementById('usersOnline');

    let localStream;
    let peerConnection;
    let matchedId;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'match') {
        createOffer(data.peerId);
      } else if (data.type === 'signal') {
        if (!peerConnection) return;
        if (data.signal.type === 'offer') {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'signal', to: data.from, signal: answer }));
        } else if (data.signal.type === 'answer') {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
        } else if (data.signal.candidate) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(data.signal));
        }
      } else if (data.type === 'status') {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        console.log(data.message);
      } else if (data.type === 'clients') {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω-—é–∑–µ—Ä–æ–≤
        if (data.users.length === 0) {
          usersOnlineDiv.innerHTML = '<b>–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:</b> ‚Äî';
        } else {
          usersOnlineDiv.innerHTML = '<b>–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:</b> ' + 
            data.users.map((u, i) => {
              let icon = '';
              if (u.instrument === 'guitar') icon = 'üé∏';
              if (u.instrument === 'keyboard') icon = 'üéπ';
              if (u.instrument === 'drums') icon = 'ü•Å';
              return `${icon} ${u.instrument[0].toUpperCase() + u.instrument.slice(1)}`;
            }).join(', ');
        }
      }
    };

    startBtn.onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        peerConnection = new RTCPeerConnection(config);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.onicecandidate = (event) => {
          if (event.candidate && matchedId) {
            ws.send(JSON.stringify({ type: 'signal', to: matchedId, signal: event.candidate }));
          }
        };

        peerConnection.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };

        const instrument = instrumentSelect.value;
        ws.send(JSON.stringify({ type: 'register', instrument }));
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message);
      }
    };

    async function createOffer(peerId) {
      matchedId = peerId;
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: 'signal', to: peerId, signal: offer }));
    }
  </script>
</body>
</html>
