<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ß–∞—Ç—Ä—É–ª–µ—Ç–∫–∞</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
    #usersOnline { margin: 20px 0; padding: 10px 20px; background: #f3f3f3; border-radius: 10px; min-width: 250px; }
    .user-row { display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; }
    .user-row.me { background: #e0ffe0; cursor: default; }
    .user-avatar { width: 40px; height: 30px; border-radius: 5px; margin-right: 8px; object-fit: cover; background: #eee; }
    .user-label { font-size: 1.1em; }
    #addAvatarBtn { margin-bottom: 15px; }
    #status { margin: 10px 0; color: #1c6; }
    #videos { display: flex; gap: 20px; margin: 15px 0; }
    video { width: 240px; height: 180px; background: #000; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>–í—ã–±–µ—Ä–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>
  <select id="instrument">
    <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>
    <option value="guitar">–ì–∏—Ç–∞—Ä–∞</option>
    <option value="keyboard">–ö–ª–∞–≤–∏—à–∏</option>
    <option value="drums">–ë–∞—Ä–∞–±–∞–Ω—ã</option>
  </select>

  <button id="addAvatarBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–±—è —Å –∫–∞–º–µ—Ä–æ–π</button>

  <div id="status"></div>
  <div id="usersOnline"><b>–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:</b> ‚Äî</div>

  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <script>
    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${wsProtocol}://${location.host}/`);

    const instrumentSelect = document.getElementById('instrument');
    const usersOnlineDiv = document.getElementById('usersOnline');
    const addAvatarBtn = document.getElementById('addAvatarBtn');
    const statusDiv = document.getElementById('status');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    let myId = null;
    let peerId = null;
    let peerConnection = null;
    let localStream = null;

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: 'register', instrument: instrumentSelect.value }));
    };

    instrumentSelect.onchange = () => {
      ws.send(JSON.stringify({ type: 'register', instrument: instrumentSelect.value }));
    };

    addAvatarBtn.onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        // –î–µ–ª–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å –∫–∞–º–µ—Ä—ã –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
        const video = document.createElement('video');
        video.srcObject = localStream;
        await video.play();

        const canvas = document.createElement('canvas');
        canvas.width = 80;
        canvas.height = 60;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const image = canvas.toDataURL('image/jpeg');

        ws.send(JSON.stringify({ type: 'avatar', image }));

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∫–∞–º–µ—Ä—É –Ω–µ –Ω—É–∂–Ω–æ ‚Äî —Ç–µ–ø–µ—Ä—å –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è WebRTC
      } catch (e) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
      }
    };

    usersOnlineDiv.onclick = (event) => {
      let row = event.target.closest('.user-row[data-userid]');
      if (row && row.dataset.userid && row.dataset.userid !== myId) {
        ws.send(JSON.stringify({ type: 'connect', targetId: row.dataset.userid }));
      }
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'clients') {
        // –£–∑–Ω–∞—ë–º —Å–≤–æ–π id (–æ–Ω –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ)
        if (!myId && data.users.length > 0) {
          // –ë–µ—Ä—ë–º —Å–≤–æ–π id –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–º—É (–∏–ª–∏ –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞/–∞–≤–∞—Ç–∞—Ä–∞)
          myId = data.users[data.users.length - 1].id;
        }
        usersOnlineDiv.innerHTML = '<b>–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:</b><br>' +
          data.users.map(u => {
            let label = '';
            if (!u.instrument) label = 'üë§ –ì–æ—Å—Ç—å';
            if (u.instrument === 'guitar') label = 'üé∏ –ì–∏—Ç–∞—Ä–∞';
            if (u.instrument === 'keyboard') label = 'üéπ –ö–ª–∞–≤–∏—à–∏';
            if (u.instrument === 'drums') label = 'ü•Å –ë–∞—Ä–∞–±–∞–Ω—ã';
            let meClass = (u.id === myId) ? 'me' : '';
            let dataId = (u.id && u.id !== myId) ? `data-userid="${u.id}"` : '';
            if (u.avatar) {
              return `<div class="user-row ${meClass}" ${dataId}><img class="user-avatar" src="${u.avatar}"><span class="user-label">${label}</span></div>`;
            } else {
              return `<div class="user-row ${meClass}" ${dataId}><span class="user-label">${label}</span></div>`;
            }
          }).join('');
      }
      if (data.type === 'status') {
        statusDiv.textContent = data.message;
        if (data.peerId) {
          peerId = data.peerId;
          if (peerId) {
            startWebRTC(peerId);
          } else {
            closeWebRTC();
          }
        }
      }
      if (data.type === 'signal') {
        if (!peerConnection) {
          peerConnection = createPeerConnection();
        }
        if (data.signal.type === 'offer') {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
          if (!localStream) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –≤–∫–ª—é—á–∏–ª –∫–∞–º–µ—Ä—É, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –µ—ë
            try {
              localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
              localVideo.srcObject = localStream;
              localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            } catch (e) {
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è WebRTC');
              return;
            }
          }
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'signal', signal: answer }));
        } else if (data.signal.type === 'answer') {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
        } else if (data.signal.candidate) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(data.signal));
        }
      }
    };

    function createPeerConnection() {
      const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
      const pc = new RTCPeerConnection(config);

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: 'signal', signal: event.candidate }));
        }
      };

      pc.ontrack = (event) => {
        // –í—ã–≤–æ–¥–∏–º –≤–∏–¥–µ–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        remoteVideo.srcObject = event.streams[0];
      };

      // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
      if (localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      }

      return pc;
    }

    async function startWebRTC(targetPeerId) {
      if (!peerConnection) peerConnection = createPeerConnection();
      if (localStream) {
        // –£–∂–µ –µ—Å—Ç—å –∫–∞–º–µ—Ä–∞, –¥–æ–±–∞–≤–∏–ª–∏ —Ç—Ä–µ–∫–∏ –≤ createPeerConnection
      } else {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–∞
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        } catch (e) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è WebRTC');
          return;
        }
      }
      // –¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç offer
      if (targetPeerId && myId) {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: 'signal', signal: offer }));
      }
    }

    function closeWebRTC() {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      remoteVideo.srcObject = null;
    }
  </script>
</body>
</html>
